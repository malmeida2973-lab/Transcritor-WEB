<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistente v16</title>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/4f46e5/ffffff?text=AV">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .transcript-box { min-height: 150px; }
        .modal { display: none; transition: opacity 0.3s ease; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.6); }
        .modal.flex { display: flex; }
        .task-completed { text-decoration: line-through; color: #9ca3af; }
        .task-text { cursor: pointer; flex-grow: 1; }
        .ai-section { display: none; }
        .input-field { @apply border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500; }
        .label-disabled { @apply opacity-50 cursor-not-allowed; }
        #privacy-overlay {
            position: fixed; inset: 0; background-color: #000000;
            z-index: 9999; display: none; align-items: center; justify-content: center;
            text-align: center; color: #333; font-size: 1rem; cursor: pointer;
            touch-action: manipulation;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="min-h-screen flex justify-center p-0 sm:p-4">

    <div class="bg-white sm:rounded-2xl shadow-xl w-full max-w-5xl mx-auto relative flex flex-col min-h-screen sm:min-h-0 overflow-hidden">
        
        <!-- Cabeçalho v16 (COM FUNDO AZUL) -->
        <header class="flex justify-between items-center p-6 bg-indigo-600 text-white shadow-md">
            <div class="flex-1">
                <h1 class="text-2xl font-bold">Assistente</h1>
                <p class="text-indigo-200 text-xs font-medium mt-0.5">v16 • Inteligente</p>
            </div>
            <div class="flex gap-4">
                <button id="privacy-button" class="text-white hover:text-indigo-200 transition flex flex-col items-center" title="Modo Privacidade">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a9.97 9.97 0 01-1.563 3.029m-5.858-.908a3 3 0 00-4.243-4.243" /></svg>
                    <span class="text-[10px]">Ecrã</span>
                </button>
                <button id="settings-button" class="text-white hover:text-indigo-200 transition flex flex-col items-center" title="Configurações">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.09 2.573-1.066z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    <span class="text-[10px]">Config</span>
                </button>
            </div>
        </header>

        <!-- Conteúdo Principal com Padding -->
        <div class="p-6 space-y-8">
            
            <!-- Seção Tarefas -->
            <div class="border-b-2 border-gray-200 pb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-3">Tarefas do Dia</h2>
                <div class="flex gap-2 mb-3">
                    <input type="text" id="task-input" class="block w-full input-field px-3 py-2" placeholder="Nova tarefa...">
                    <button id="add-task-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition">+</button>
                </div>
                <div id="task-list" class="space-y-2 max-h-[200px] overflow-y-auto pr-1"><p id="tasks-loading" class="text-sm text-gray-500">A carregar...</p></div>
            </div>

            <!-- Seção Agendamentos -->
            <div class="border-b-2 border-gray-200 pb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-3">Visitas Agendadas</h2>
                <!-- Botão Toggle Agendamento -->
                <button onclick="document.getElementById('schedule-form').classList.toggle('hidden')" class="text-sm text-indigo-600 font-medium mb-3 hover:underline">+ Novo Agendamento</button>
                
                <div id="schedule-form" class="hidden bg-gray-50 p-4 rounded-lg border border-gray-200 mb-4">
                    <div class="grid grid-cols-1 gap-3 mb-3">
                        <input type="text" id="scheduledClientName" class="input-field px-3 py-2" placeholder="Nome do Cliente">
                        <input type="text" id="scheduledContactPerson" class="input-field px-3 py-2" placeholder="Pessoa de Contato">
                        <input type="email" id="scheduledEmail" class="input-field px-3 py-2" placeholder="Email (Opcional)">
                    </div>
                    <button id="saveScheduleButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg shadow-sm">Salvar Agendamento</button>
                </div>
                <div id="scheduled-visits-list" class="space-y-3 max-h-[200px] overflow-y-auto"><p id="scheduled-loading" class="text-sm text-gray-500">A carregar...</p></div>
            </div>

            <!-- Seção Gravação -->
            <div class="border-b-2 border-gray-200 pb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Gravação Atual</h2>
                <div class="grid grid-cols-1 gap-3 mb-4">
                    <input type="text" id="clientNameInput" class="input-field px-3 py-2" placeholder="Nome do Cliente (Obrigatório)">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="contactPersonInput" class="input-field px-3 py-2" placeholder="Contato">
                        <input type="email" id="emailInput" class="input-field px-3 py-2" placeholder="Email">
                    </div>
                </div>

                <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 text-center">
                    <div id="timerDisplay" class="text-3xl font-mono font-bold text-gray-700 mb-4">00:00:00</div>
                    
                    <div class="flex flex-wrap justify-center gap-3">
                        <button id="startButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition transform active:scale-95 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                            Gravar
                        </button>
                        <button id="stopButton" disabled class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition transform active:scale-95 disabled:opacity-50 disabled:transform-none flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" /></svg>
                            Parar
                        </button>
                    </div>
                    <div class="mt-4 flex justify-center gap-3">
                         <button id="saveManualButton" class="text-sm text-blue-600 font-medium hover:underline">Anotação Manual (Sem Áudio)</button>
                         <span class="text-gray-300">|</span>
                         <button id="clearButton" class="text-sm text-gray-500 font-medium hover:text-gray-700">Limpar</button>
                    </div>
                    <div id="status" class="text-xs text-gray-500 mt-2 h-4">Pronto.</div>
                </div>
                <!-- Ocultos -->
                <div class="hidden"><div id="interim-transcript"></div><textarea id="final-transcript"></textarea><select id="languageSelect"><option value="pt-BR">PT</option></select></div>
            </div>

            <!-- Seção Histórico -->
            <div>
                <h2 class="text-xl font-bold text-gray-800 mb-4">Histórico</h2>
                <div id="history-list" class="space-y-3 max-h-[400px] overflow-y-auto pr-1"><p id="history-loading" class="text-sm text-gray-500">A carregar...</p></div>
            </div>
        </div>
    </div>

    <!-- Modal Privacidade -->
    <div id="privacy-overlay">
        <div>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a9.97 9.97 0 01-1.563 3.029m-5.858-.908a3 3 0 00-4.243-4.243" /></svg>
            <p class="font-bold text-lg">Ecrã Oculto</p>
            <p class="text-sm text-gray-500 mt-2">Toque 2 vezes para voltar</p>
        </div>
    </div>

    <!-- Modal Configurações -->
    <div id="settings-modal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="modal-overlay fixed inset-0"></div>
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md z-10 overflow-hidden">
            <div class="flex justify-between items-center p-4 bg-gray-50 border-b"><h3 class="font-bold text-gray-800">Configurações</h3><button id="settings-modal-close-button" class="text-gray-500">✕</button></div>
            <div class="p-6 space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Chave API Gemini</label>
                    <input type="password" id="gemini-api-key-input" class="w-full input-field px-3 py-2" placeholder="Cole a chave aqui">
                    <div id="api-key-status" class="text-xs mt-1 h-4"></div>
                </div>
                <div class="pt-4 border-t">
                    <button id="export-data-button" disabled class="w-full bg-blue-600 text-white font-bold py-2 rounded mb-2 disabled:opacity-50">Exportar Backup</button>
                    <input type="file" id="import-data-input" class="hidden" accept=".json" disabled>
                    <label for="import-data-input" id="import-data-label" class="block w-full text-center bg-green-600 text-white font-bold py-2 rounded cursor-pointer label-disabled">Importar Backup</label>
                    <div id="backup-status" class="text-xs text-center mt-2 text-gray-500">...</div>
                </div>
                <div class="pt-4 border-t">
                    <button id="force-update-button" class="w-full border border-red-500 text-red-600 font-bold py-2 rounded hover:bg-red-50">Forçar Atualização (Reset)</button>
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-t flex justify-end"><button id="save-api-key-button" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded">Salvar</button></div>
        </div>
    </div>

    <!-- Modal Detalhes -->
    <div id="visit-modal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="modal-overlay fixed inset-0"></div>
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-3xl z-10 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b"><h3 id="modal-title" class="text-lg font-bold text-gray-800">Detalhes</h3><button id="modal-close-button" class="text-gray-500 text-xl">✕</button></div>
            <div class="p-6 space-y-4 overflow-y-auto flex-grow">
                <div><span class="text-xs text-gray-500 uppercase">Cliente</span><p id="modal-client-name" class="font-bold text-lg text-gray-900"></p></div>
                <div><span class="text-xs text-gray-500 uppercase">Data</span><p id="modal-date-time" class="text-sm text-gray-700"></p></div>
                
                <div id="modal-audio-section" class="bg-gray-50 p-3 rounded-lg border">
                    <div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-gray-500 uppercase">Áudio</span></div>
                    <audio id="modalAudioPlayer" controls class="w-full mb-3 h-10"></audio>
                    <button id="modal-ai-transcribe-audio-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded shadow flex items-center justify-center gap-2 transition ai-button" style="display:none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                        Transcrever (Gemini 2.0)
                    </button>
                    <p class="text-[10px] text-gray-400 mt-1 text-center">Se falhar quota, tenta auto. Gemini 1.5</p>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Transcrição / Notas</label>
                    <textarea id="modalTranscriptTextarea" class="w-full p-3 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" rows="6"></textarea>
                </div>
                <div id="modal-status-message" class="text-xs font-bold h-4"></div>

                <div id="modal-ai-summary-section" class="ai-section"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Resumo IA</label><textarea id="ai-summary-result" class="w-full p-3 bg-indigo-50 border border-indigo-100 rounded-lg" rows="4" readonly></textarea></div>
                <div id="modal-ai-tasks-section" class="ai-section"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tarefas IA</label><textarea id="ai-tasks-result" class="w-full p-3 bg-indigo-50 border border-indigo-100 rounded-lg" rows="4"></textarea><button id="add-ai-tasks-button" class="mt-2 w-full bg-indigo-100 text-indigo-700 font-bold py-2 rounded hover:bg-indigo-200">Adicionar à Lista</button></div>
            </div>

            <div class="p-4 bg-gray-50 border-t flex justify-between items-center flex-wrap gap-2">
                <div class="flex gap-2">
                    <button id="modal-ai-summarize-button" class="bg-white border border-gray-300 text-gray-700 font-bold py-2 px-3 rounded hover:bg-gray-100 ai-button text-sm" style="display:none">Resumir</button>
                    <button id="modal-ai-extract-button" class="bg-white border border-gray-300 text-gray-700 font-bold py-2 px-3 rounded hover:bg-gray-100 ai-button text-sm" style="display:none">Tarefas</button>
                </div>
                <div class="flex gap-2">
                    <button id="modal-save-changes-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded text-sm">Salvar</button>
                    <button id="modal-export-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded text-sm">Exportar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="delete-confirm-modal" class="modal fixed inset-0 z-50 items-center justify-center p-4"><div class="modal-overlay fixed inset-0"></div><div class="bg-white rounded-xl shadow-xl w-full max-w-xs p-6 text-center"><h3 class="text-lg font-bold text-gray-800 mb-2">Tem a certeza?</h3><p class="text-sm text-gray-500 mb-6">Não poderá recuperar este registo.</p><div class="flex justify-center gap-3"><button id="delete-confirm-cancel" class="flex-1 py-2 bg-gray-200 text-gray-700 font-bold rounded">Não</button><button id="delete-confirm-ok" class="flex-1 py-2 bg-red-600 text-white font-bold rounded">Sim, Apagar</button></div></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let mediaRecorder, audioChunks = [], audioStream, timerInterval, startTime, wakeLock = null, userApiKey = null;
            
            // CONFIGURAÇÃO DE MODELOS (v16)
            const GEMINI_2_0 = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=";
            const GEMINI_1_5 = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=";
            
            let db, currentVisitIdToExport=null, currentVisitDataToExport=null, currentScheduledVisitId=null;
            const DB_NAME="VisitAssistantDB", DB_VERSION=3, VISIT_STORE="visits", SCHEDULE_STORE="scheduledVisits", TASK_STORE="tasks";

            // UI Elements
            const els = {
                settingsBtn: document.getElementById('settings-button'), settingsModal: document.getElementById('settings-modal'), settingsClose: document.getElementById('settings-modal-close-button'), 
                apiKeyInput: document.getElementById('gemini-api-key-input'), saveKeyBtn: document.getElementById('save-api-key-button'), keyStatus: document.getElementById('api-key-status'),
                forceUpdateBtn: document.getElementById('force-update-button'), privacyBtn: document.getElementById('privacy-button'), privacyOverlay: document.getElementById('privacy-overlay'),
                exportBtn: document.getElementById('export-data-button'), importInput: document.getElementById('import-data-input'), importLabel: document.getElementById('import-data-label'), backupStatus: document.getElementById('backup-status'),
                taskInput: document.getElementById('task-input'), addTaskBtn: document.getElementById('add-task-button'), taskList: document.getElementById('task-list'),
                schName: document.getElementById('scheduledClientName'), schContact: document.getElementById('scheduledContactPerson'), schEmail: document.getElementById('scheduledEmail'), saveSchBtn: document.getElementById('saveScheduleButton'), schList: document.getElementById('scheduled-visits-list'),
                startBtn: document.getElementById('startButton'), stopBtn: document.getElementById('stopButton'), clearBtn: document.getElementById('clearButton'), manualBtn: document.getElementById('saveManualButton'),
                status: document.getElementById('status'), timer: document.getElementById('timerDisplay'), cName: document.getElementById('clientNameInput'), cContact: document.getElementById('contactPersonInput'), cEmail: document.getElementById('emailInput'),
                histList: document.getElementById('history-list'),
                vModal: document.getElementById('visit-modal'), vClose: document.getElementById('modal-close-button'), vTitle: document.getElementById('modal-title'), vName: document.getElementById('modal-client-name'), vDate: document.getElementById('modal-date-time'), vAudioSec: document.getElementById('modal-audio-section'), vAudio: document.getElementById('modalAudioPlayer'), vText: document.getElementById('modalTranscriptTextarea'), vSave: document.getElementById('modal-save-changes-button'), vExport: document.getElementById('modal-export-button'), vMsg: document.getElementById('modal-status-message'),
                aiTranscribe: document.getElementById('modal-ai-transcribe-audio-button'), aiSumBtn: document.getElementById('modal-ai-summarize-button'), aiExtBtn: document.getElementById('modal-ai-extract-button'), aiSumSec: document.getElementById('modal-ai-summary-section'), aiSumRes: document.getElementById('ai-summary-result'), aiTaskSec: document.getElementById('modal-ai-tasks-section'), aiTaskRes: document.getElementById('ai-tasks-result'), aiAddTasks: document.getElementById('add-ai-tasks-button'),
                delModal: document.getElementById('delete-confirm-modal'), delCancel: document.getElementById('delete-confirm-cancel'), delOk: document.getElementById('delete-confirm-ok')
            };
            let deleteConfig = { id: null, store: null };

            // Helpers
            const blobToBase64 = (b) => new Promise((r,j) => {if(!b)r(null);const fr=new FileReader();fr.readAsDataURL(b);fr.onloadend=()=>r(fr.result);fr.onerror=e=>j(e);});
            const promisify = (req) => new Promise((r,j) => {req.onsuccess=()=>r(req.result);req.onerror=(e)=>j(e.target.error);});
            
            // API Logic (v16 - Fallback)
            function loadApiKey() { const k = localStorage.getItem('geminiApiKey'); if(k){ userApiKey=k; els.apiKeyInput.value=k; els.keyStatus.textContent='Chave OK'; els.keyStatus.className='text-green-600'; } else { els.keyStatus.textContent='Sem chave'; els.keyStatus.className='text-red-600'; } }
            
            async function callGeminiApi(prompt, btn, inlineData=null) {
                if(!userApiKey){ els.vMsg.textContent='Erro: Falta Chave API'; return null; }
                const oldText = btn.innerHTML; btn.innerHTML = '⏳ A processar...'; btn.disabled = true;
                
                const parts = [{ text: prompt }];
                if(inlineData) parts.push({ inlineData: { mimeType: inlineData.mimeType, data: inlineData.data } });
                
                const payload = { contents: [{ parts: parts }], generationConfig: { temperature: 0.4, maxOutputTokens: 8000 } };

                // Tenta Modelo 2.0
                try {
                    console.log("Tentando Gemini 2.0...");
                    const res = await fetch(GEMINI_2_0 + userApiKey, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                    
                    if (res.status === 429 || res.status === 503) { throw new Error("QUOTA_LIMIT"); } // Força fallback
                    if (!res.ok) throw new Error((await res.json()).error.message || res.status);
                    
                    const json = await res.json();
                    return json.candidates[0].content.parts[0].text;

                } catch (err) {
                    console.warn("Gemini 2.0 falhou:", err.message);
                    
                    // FALLBACK PARA 1.5 FLASH
                    if (err.message.includes("QUOTA") || err.message.includes("429") || err.message.includes("503") || err.message.includes("not found")) {
                        els.vMsg.textContent = "2.0 Ocupado/Cota. Tentando 1.5 Flash...";
                        try {
                            console.log("Tentando Fallback Gemini 1.5...");
                            const resBackup = await fetch(GEMINI_1_5 + userApiKey, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                            if(!resBackup.ok) throw new Error((await resBackup.json()).error.message);
                            const jsonBackup = await resBackup.json();
                            return jsonBackup.candidates[0].content.parts[0].text;
                        } catch (errBackup) {
                            els.vMsg.textContent = `Erro Fatal (1.5): ${errBackup.message}`;
                            els.vMsg.className = 'text-red-600 text-xs font-bold';
                            return null;
                        }
                    } else {
                        els.vMsg.textContent = `Erro: ${err.message}`;
                        els.vMsg.className = 'text-red-600 text-xs font-bold';
                        return null;
                    }
                } finally {
                    btn.innerHTML = oldText; btn.disabled = false;
                }
            }

            // DB
            function initDB() {
                const r = indexedDB.open(DB_NAME, DB_VERSION);
                r.onsuccess = (e) => { db=e.target.result; els.exportBtn.disabled=false; els.importInput.disabled=false; els.importLabel.classList.remove('label-disabled'); els.backupStatus.textContent='Pronto.'; loadAll(); loadApiKey(); };
                r.onupgradeneeded = (e) => { let d=e.target.result; if(!d.objectStoreNames.contains(VISIT_STORE)) d.createObjectStore(VISIT_STORE,{keyPath:'id',autoIncrement:true}); if(!d.objectStoreNames.contains(SCHEDULE_STORE)) d.createObjectStore(SCHEDULE_STORE,{keyPath:'id',autoIncrement:true}); if(!d.objectStoreNames.contains(TASK_STORE)) d.createObjectStore(TASK_STORE,{keyPath:'id',autoIncrement:true}); };
            }
            function loadAll() { loadHistory(); loadSch(); loadTasks(); }

            // Core Logic (Minified for brevity, logic remains consistent)
            function saveTask(t){if(!db)return;const tr=db.transaction([TASK_STORE],'readwrite');tr.objectStore(TASK_STORE).add({text:t,completed:false});tr.onsuccess=loadTasks;}
            function loadTasks(){if(!db)return;db.transaction([TASK_STORE],'readonly').objectStore(TASK_STORE).getAll().onsuccess=(e)=>{els.taskList.innerHTML='';e.target.result.sort((a,b)=>a.completed-b.completed).forEach(t=>{const d=document.createElement('div');d.className='flex justify-between p-2 bg-gray-50 rounded border mb-1';d.innerHTML=`<span class="${t.completed?'line-through text-gray-400':''} cursor-pointer flex-1" onclick="toggleTask(${t.id})">${t.text}</span><button onclick="delTask(${t.id})" class="text-red-500 px-2">×</button>`;els.taskList.appendChild(d);});}}
            window.toggleTask=(id)=>{const s=db.transaction([TASK_STORE],'readwrite').objectStore(TASK_STORE);s.get(id).onsuccess=(e)=>{let d=e.target.result;d.completed=!d.completed;s.put(d).onsuccess=loadTasks;}};
            window.delTask=(id)=>{db.transaction([TASK_STORE],'readwrite').objectStore(TASK_STORE).delete(id).onsuccess=loadTasks;}
            
            els.addTaskBtn.onclick=()=>{if(els.taskInput.value){saveTask(els.taskInput.value);els.taskInput.value='';}};
            
            function saveSch(){if(!els.schName.value)return;db.transaction([SCHEDULE_STORE],'readwrite').objectStore(SCHEDULE_STORE).add({clientName:els.schName.value,contactPerson:els.schContact.value,email:els.schEmail.value,status:'scheduled'}).onsuccess=()=>{loadSch();els.schName.value='';};}
            function loadSch(){if(!db)return;db.transaction([SCHEDULE_STORE],'readonly').objectStore(SCHEDULE_STORE).getAll().onsuccess=(e)=>{els.schList.innerHTML='';e.target.result.filter(s=>s.status==='scheduled').forEach(s=>{const d=document.createElement('div');d.className='flex justify-between p-3 bg-white border rounded mb-2';d.innerHTML=`<div><b>${s.clientName}</b><br class="text-xs">${s.contactPerson}</div><div><button onclick="loadVisitSch(${s.id})" class="bg-green-100 text-green-700 px-2 rounded mr-1">Ir</button><button onclick="delSch(${s.id})" class="bg-red-100 text-red-700 px-2 rounded">×</button></div>`;els.schList.appendChild(d);});}}
            window.loadVisitSch=(id)=>{db.transaction([SCHEDULE_STORE],'readonly').objectStore(SCHEDULE_STORE).get(id).onsuccess=(e)=>{const d=e.target.result;els.cName.value=d.clientName;els.cContact.value=d.contactPerson;els.cEmail.value=d.email;currentScheduledVisitId=d.id;els.status.textContent='Agendamento carregado.';window.scrollTo(0,els.cName.offsetTop-100);}}
            window.delSch=(id)=>{db.transaction([SCHEDULE_STORE],'readwrite').objectStore(SCHEDULE_STORE).delete(id).onsuccess=loadSch;}
            els.saveSchBtn.onclick=saveSch;

            // Recorder & WakeLock
            const reqWL=async()=>{if('wakeLock'in navigator){try{wakeLock=await navigator.wakeLock.request('screen');els.status.textContent='A Gravar (Ecrã Bloqueado)';}catch(e){els.status.textContent='A Gravar';}}};
            const relWL=async()=>{if(wakeLock){await wakeLock.release();wakeLock=null;}};
            
            els.startBtn.onclick=async()=>{
                if(!els.cName.value){alert('Nome obrigatório');return;}
                try{
                    audioStream=await navigator.mediaDevices.getUserMedia({audio:true});
                    isRecording=true; audioChunks=[]; startTime=Date.now();
                    timerInterval=setInterval(()=>{els.timer.textContent=new Date(Date.now()-startTime).toISOString().slice(11,19);},1000);
                    await reqWL();
                    mediaRecorder=new MediaRecorder(audioStream);
                    mediaRecorder.ondataavailable=e=>{if(e.data.size>0)audioChunks.push(e.data);};
                    mediaRecorder.onstop=()=>{
                        const blob=new Blob(audioChunks,{type:'audio/webm'});
                        saveVisit({clientName:els.cName.value,contactPerson:els.cContact.value,email:els.cEmail.value,dateTime:new Date().toISOString(),transcript:'',audioBlob:blob});
                        audioStream.getTracks().forEach(t=>t.stop());
                    };
                    mediaRecorder.start();
                    els.startBtn.classList.add('hidden'); els.stopBtn.disabled=false; els.stopBtn.classList.remove('hidden');
                    els.manualBtn.disabled=true;
                }catch(e){alert('Erro Mic: '+e);}
            };
            
            els.stopBtn.onclick=async()=>{if(!isRecording)return;isRecording=false;clearInterval(timerInterval);await relWL();mediaRecorder.stop();els.startBtn.classList.remove('hidden');els.stopBtn.classList.add('hidden');els.manualBtn.disabled=false;els.status.textContent='Guardado.';};
            els.manualBtn.onclick=()=>{if(!els.cName.value){alert('Nome obrigatório');return;}saveVisit({clientName:els.cName.value,contactPerson:els.cContact.value,email:els.cEmail.value,dateTime:new Date().toISOString(),transcript:'Nota Manual',audioBlob:null});};
            els.clearBtn.onclick=()=>{isRecording=false;clearInterval(timerInterval);relWL();els.cName.value='';els.timer.textContent='00:00:00';els.startBtn.classList.remove('hidden');els.stopBtn.classList.add('hidden');};

            function saveVisit(d){db.transaction([VISIT_STORE],'readwrite').objectStore(VISIT_STORE).add(d).onsuccess=()=>{loadHistory();if(currentScheduledVisitId){db.transaction([SCHEDULE_STORE],'readwrite').objectStore(SCHEDULE_STORE).get(currentScheduledVisitId).onsuccess=(e)=>{let s=e.target.result;s.status='completed';db.transaction([SCHEDULE_STORE],'readwrite').objectStore(SCHEDULE_STORE).put(s).onsuccess=loadSch;currentScheduledVisitId=null;}};els.cName.value='';els.timer.textContent='00:00:00';};}
            function loadHistory(){if(!db)return;db.transaction([VISIT_STORE],'readonly').objectStore(VISIT_STORE).getAll().onsuccess=(e)=>{els.histList.innerHTML='';e.target.result.sort((a,b)=>new Date(b.dateTime)-new Date(a.dateTime)).forEach(v=>{const d=document.createElement('div');d.className='p-3 bg-white border rounded mb-2 flex justify-between items-center';d.innerHTML=`<div><b>${v.clientName}</b><br><span class="text-xs text-gray-500">${new Date(v.dateTime).toLocaleDateString()}</span>${!v.audioBlob?'<span class="text-[10px] bg-blue-100 text-blue-800 px-1 rounded ml-2">Manual</span>':''}</div><div><button onclick="openVisit(${v.id})" class="bg-indigo-50 text-indigo-700 px-3 py-1 rounded mr-2 text-sm">Ver</button><button onclick="askDel(${v.id})" class="text-red-400 px-2">×</button></div>`;els.histList.appendChild(d);});}}
            
            window.askDel=(id)=>{deleteConfig={id:id,store:VISIT_STORE};els.delModal.style.display='flex';}
            els.delCancel.onclick=()=>{els.delModal.style.display='none';};
            els.delOk.onclick=()=>{db.transaction([deleteConfig.store],'readwrite').objectStore(deleteConfig.store).delete(deleteConfig.id).onsuccess=()=>{els.delModal.style.display='none';loadAll();};}

            window.openVisit=(id)=>{
                db.transaction([VISIT_STORE],'readonly').objectStore(VISIT_STORE).get(id).onsuccess=(e)=>{
                    const v=e.target.result; currentVisitIdToExport=v.id; currentVisitDataToExport=v;
                    els.vName.textContent=v.clientName; els.vDate.textContent=new Date(v.dateTime).toLocaleString(); els.vText.value=v.transcript||'';
                    els.aiSumSec.style.display='none'; els.aiTaskSec.style.display='none'; els.vMsg.textContent='';
                    const hasKey = !!userApiKey;
                    document.querySelectorAll('.ai-button').forEach(b=>b.style.display=hasKey?'inline-flex':'none');
                    
                    if(v.audioBlob){
                        els.vAudioSec.style.display='block'; els.vAudio.src=URL.createObjectURL(v.audioBlob);
                        els.aiTranscribe.style.display = hasKey ? 'flex' : 'none';
                    } else {
                        els.vAudioSec.style.display='none'; els.aiTranscribe.style.display='none';
                    }
                    els.vModal.style.display='flex';
                }
            }
            els.vClose.onclick=()=>{els.vModal.style.display='none';}
            
            // IA Actions (v16 Updated)
            els.aiTranscribe.onclick=async()=>{
                if(!currentVisitDataToExport?.audioBlob)return;
                const b64raw = await blobToBase64(currentVisitDataToExport.audioBlob);
                const b64 = b64raw.split(',')[1]; const mime = b64raw.split(';')[0].split(':')[1];
                const res = await callGeminiApi("Transcreva este áudio fielmente em PT-BR. Formate bem.", els.aiTranscribe, {mimeType:mime, data:b64});
                if(res){
                    els.vText.value = res; els.vMsg.textContent = 'Transcrição OK!'; els.vMsg.className = 'text-green-600 text-xs font-bold';
                    saveVisitChanges();
                }
            };
            
            els.aiSumBtn.onclick=async()=>{
                const res = await callGeminiApi(`Resuma em tópicos:\n"${els.vText.value}"`, els.aiSumBtn);
                if(res){ els.aiSumSec.style.display='block'; els.aiSumRes.value = res; }
            };
            
            els.aiExtBtn.onclick=async()=>{
                const res = await callGeminiApi(`Extraia lista de tarefas:\n"${els.vText.value}"`, els.aiExtBtn);
                if(res){ els.aiTaskSec.style.display='block'; els.aiTaskRes.value = res; }
            };

            els.aiAddTasks.onclick=()=>{
                const l = els.aiTaskRes.value.split('\n').map(t=>t.replace(/^- /,'').trim()).filter(t=>t);
                l.forEach(t=>saveTask(t));
                alert(`${l.length} tarefas adicionadas!`);
            };
            
            function saveVisitChanges(){
                const tr=db.transaction([VISIT_STORE],'readwrite');
                const st=tr.objectStore(VISIT_STORE);
                st.get(currentVisitIdToExport).onsuccess=(e)=>{let d=e.target.result;d.transcript=els.vText.value;st.put(d);els.vMsg.textContent='Salvo!';};
            }
            els.vSave.onclick=saveVisitChanges;

            // Configs & Utils
            els.settingsBtn.onclick=()=>{els.settingsModal.style.display='flex';};
            els.settingsClose.onclick=()=>{els.settingsModal.style.display='none';};
            els.saveKeyBtn.onclick=()=>{const k=els.apiKeyInput.value.trim(); if(k) localStorage.setItem('geminiApiKey',k); else localStorage.removeItem('geminiApiKey'); loadApiKey(); els.settingsModal.style.display='none';};
            els.forceUpdateBtn.onclick=()=>{
                if(confirm("Resetar app e limpar cache?")){
                    if('serviceWorker' in navigator){navigator.serviceWorker.getRegistrations().then(rs=>rs.forEach(r=>r.unregister()));}
                    caches.keys().then(ns=>ns.forEach(n=>caches.delete(n)));
                    window.location.reload(true);
                }
            };
            els.privacyBtn.onclick=()=>{els.privacyOverlay.style.display='flex';};
            els.privacyOverlay.ondblclick=()=>{els.privacyOverlay.style.display='none';};
            
            document.addEventListener('visibilitychange', async () => { if (wakeLock && document.visibilityState === 'visible' && isRecording) await reqWL(); });

            initDB();
        });
    </script>
</body>
</html>